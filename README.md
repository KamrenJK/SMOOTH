# SMOOTH: Surrogate Map-Based Group-Level Analysis of Human Intracranial EEG Data

*SMOOTH* (**S**urrogate **M**ap **O**ptimized **O**bservation and **T**opographic **Hy**pothesis-testing) is a MATLAB toolbox for **hypothesis-generating group-level statistical inference on intracranial EEG (ECoG/sEEG) data.**

It is designed for the common iEEG challenge of **sparse, heterogeneous, and non-overlapping electrode coverage** across subjects. *SMOOTH* provides a principled way to aggregate data across subjects while respecting the geometry and sampling structure of iEEG and avoiding reliance on arbitrary atlases.

---

## How does *SMOOTH* work?

*SMOOTH* aggregates subject-level data into shared space and compares across subject alignment with a surrogate distribution generated by spectral resampling. 

---

## Why use *SMOOTH*

- **Hypothesis-generating analyses:** data-driven and capable of pre-hypothesis analyses
- **Coverage-aware group inference:** robust when subjects have highly variable electrode coverage.
- **Spatially valid nulls:** surrogates preserve smoothness and spatial dependence expected from the sampling geometry.
- **Cluster-level control:** powerful group-level multiple-comparisons correction.

---

## Minimal workflow

### 1) Prepare inputs
Provide a set of subject-level FieldTrip-like `source` structs (one per subject), where each subject contains:
- *fsavg* electrode positions (`source.elec.chanpos`)
- a per-electrode effect or statistic (`source.stat`)

### 2) Run group inference: `SMOOTHstat`
`SMOOTHstat(cfg, source{:})` produces:
- a group-level statistical map (`stat.stat`)
- a significance mask (`stat.mask`)
- optionally: subject maps and surrogates (for diagnostics/figures)

### 3) Start here: `SMOOTHdemo`
The demo script is the intended entry point:
- sets paths (SMOOTH + FieldTrip + FreeSurfer)
- loads an example dataset
- runs `SMOOTHstat`
- visualizes the group t-map + significant effects
- optionally runs `SMOOTHdiag` for surrogate QC

---

## Key parameters

- `cfg.fshome` (**required**): FreeSurfer home (must contain `subjects/fsaverage`)
- `cfg.numrandomization`: # surrogates / permutations
- `cfg.kernelwidth`: smoothing width (mm; typically 20â€“40 depending on data)
- `cfg.graphsigma`: gaussian kernel width (mm) used to generate weighted adj matrix (higher values mean more global structure; changes eigenspectrum of graph laplacian)
- `cfg.smooth`: mapping space (commonly `'sphere'` for speed)
- `cfg.kernel`: kernel type (commonly `'gaussian'`)
- `cfg.rankrescale`: whether/how surrogate values are distribution-matched (often `'exact'` for 1:1 marginal dstribution mapping)
- `cfg.keepmaps`, `cfg.keepsurrogates`: set to `'yes'` when you want diagnostics or paper figures though computationally expensive

---

## Outputs

`stat = SMOOTHstat(...)` returns a struct with:
- `stat.stat`: group-level map on fsaverage vertices (e.g., t-map)
- `stat.mask`: significance mask (cluster-inference result)
- `stat.coverage`: per-vertex coverage map
- optional fields for QC/visualization if you enable them:
  - `stat.maps` (subject maps)
  - `stat.surrogate_subject`, `stat.surrogate_group`
  - cluster null distributions (for POP/QC)

---

## Note on usage

Surrogate maps are invalid if their spatial autocorrelation is not equivalent to that of the empirical data. Use `SMOOTHdiag` or `SMOOTHsub`. If smoothness is unmatched, you can toggle `cfg.kernelwidth` or `cfg.graphsigma` to optimize.

---

## Dependencies

- MATLAB
- FieldTrip
- FreeSurfer (fsaverage surfaces available)

Some figure scripts additionally require common helper utilities (colormaps, DK parcellation helpers, etc.), but **core usage** is: FieldTrip + FreeSurfer + SMOOTH.

---

## Conclusion

Use *SMOOTH* for **reliable group-level statistics from sparse, heterogeneous iEEG electrode coverage**, with hypothesis generating inference grounded in **spatially valid surrogate data.**
